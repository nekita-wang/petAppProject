# "附近"功能完整实现方案

## 📋 功能概述

基于您的完整业务需求，我已经设计了一套完整的"附近"功能实现方案，包含：

1. **定位器功能** - 地址搜索、地图定位、自定义位置
2. **筛选器功能** - 宠物品种、距离、在线时间、年龄、性别筛选
3. **正文展示** - 宠主信息卡片展示
4. **个人主页** - 访客视角和宠主视角
5. **社交功能** - 关注、聊天、动态互动

## 🗄️ 数据库设计

### 新增表结构

1. **`user_location`** - 用户位置信息表
   - 支持GPS+基站+WiFi混合定位
   - 精度≤10米
   - 实时更新（60秒间隔）

2. **`user_online_status`** - 用户在线状态表
   - 在线状态管理
   - 设备信息记录
   - 权限状态跟踪

3. **`user_follow`** - 用户关注关系表
   - 关注/粉丝关系
   - 支持关注数和粉丝数统计

4. **`user_post`** - 用户动态表
   - 图文/视频/纯文字动态
   - 可见范围控制（所有人/仅粉丝/仅自己）
   - 互动数据统计

5. **`post_like`** - 动态点赞表
6. **`post_comment`** - 动态评论表
7. **`post_favorite`** - 动态收藏表
8. **`user_ip_location`** - IP属地记录表
9. **`chat_session`** - 聊天会话表

### 核心函数

- **`calculate_distance()`** - 距离计算函数（Haversine公式）
- **`format_online_duration()`** - 在线时间格式化函数
- **`get_user_follow_count()`** - 获取用户关注数
- **`get_user_fans_count()`** - 获取用户粉丝数

## 🎯 核心功能实现

### 1. 定位器功能

#### 1.1 地址搜索定位
```java
@PostMapping("/location/search")
public AjaxResult searchLocation(@RequestParam("address") String address)
```
- 调用地图API（高德/百度）进行地址解析
- 返回精确坐标信息
- 支持省市区详细信息

#### 1.2 自定义位置设置
```java
@PostMapping("/location/custom") 
public AjaxResult setCustomLocation(Long userId, BigDecimal latitude, BigDecimal longitude, String address)
```
- 用户手动设置位置
- 更新位置数据库
- 刷新附近用户距离计算

### 2. 筛选器功能

#### 2.1 距离筛选
- **0-1公里** / **1-3公里** / **3-5公里** / **5公里以上**
- 支持拖拽圆圈选择距离范围
- 实时距离提示

#### 2.2 宠物品种筛选
```java
@GetMapping("/pet-breeds/search")
public AjaxResult searchPetBreeds(@RequestParam("keyword") String keyword)
```
- 关键词模糊搜索（如"布偶"匹配"布偶猫"）
- 热门品种推荐
- 支持多品种组合筛选

#### 2.3 在线时间筛选
- **在线** / **1小时内** / **1天内** / **1周内** / **1月内**
- 基于`last_logoff_time`字段计算
- 颜色区分（绿色=在线，黑色=离线）

#### 2.4 年龄和性别筛选
- 年龄范围滑动选择
- 性别多选支持
- 组合筛选交集结果

### 3. 正文展示功能

#### 3.1 用户信息卡片
```java
@GetMapping("/users")
public TableDataInfo getNearbyUsers(Long userId, Integer pageNum, Integer pageSize, Integer radius)
```

**卡片包含信息：**
- **头像** - `user.avatar_url`
- **昵称** - `user.nick_name`  
- **距离** - 实时计算，格式化显示（100m/1.2km）
- **在线时间** - 按需求规则格式化显示
- **个性签名** - 最多2行，超出用"..."省略
- **宠物信息** - 品种+性别，最多显示2个，超出显示"+数字"

#### 3.2 数据格式化
- 距离：小于1000米显示"米"，大于等于1000米显示"公里"
- 在线时间：≤1分钟显示"在线"（绿色），其他按时间间隔显示（黑色）
- 宠物性别：♂/♀符号显示

### 4. 个人主页功能

#### 4.1 访客视角
```java
@GetMapping("/user/profile/{userId}")
public AjaxResult getUserProfile(@PathVariable("userId") Long userId, @RequestParam("currentUserId") Long currentUserId)
```

**显示内容：**
- 基本信息：头像、昵称、年龄、性别、距离、在线时间、IP属地
- 个性签名：完整显示，不省略
- 关注数/粉丝数：只显示数量，不可点击查看明细
- 页签：**动态** / **宠物**
- 操作按钮：**关注** / **聊天**

#### 4.2 宠主视角
**显示内容：**
- 所有访客视角内容
- 关注数/粉丝数：可点击查看明细列表
- 页签：**动态** / **宠物** / **待办**
- 操作按钮：**发布**

### 5. 动态功能

#### 5.1 动态展示
```java
@GetMapping("/user/{userId}/posts")
public TableDataInfo getUserPosts(Long userId, Long currentUserId, Integer pageNum, Integer pageSize)
```

**动态信息：**
- 发布者头像、发布地点（IP属地）、发布时间
- 内容类型：图文（1-9宫格）/视频/纯文字
- 文字内容：最多5行，超出折叠
- 互动数据：点赞数、评论数、分享数、浏览数

#### 5.2 动态互动
```java
@PostMapping("/post/like")
public AjaxResult likePost(Long postId, Long userId, Boolean isLike)

@PostMapping("/post/favorite") 
public AjaxResult favoritePost(Long postId, Long userId, Boolean isFavorite)
```

#### 5.3 动态设置（仅宠主）
```java
@PutMapping("/post/{postId}/visibility")
public AjaxResult updatePostVisibility(Long postId, Long userId, Integer visibility)

@DeleteMapping("/post/{postId}")
public AjaxResult deletePost(Long postId, Long userId)
```

**可见范围：**
- **所有人可见** - 所有用户可查看
- **仅粉丝可见** - 只有关注者可查看  
- **仅自己可见** - 只有发布者可查看

### 6. 社交功能

#### 6.1 关注系统
```java
@PostMapping("/user/follow")
public AjaxResult followUser(Long followerId, Long followedId, Boolean isFollow)
```
- 关注/取消关注
- 关注状态实时更新
- 关注数/粉丝数自动统计

#### 6.2 聊天功能
- 点击聊天按钮跳转私信对话框
- 会话管理和未读消息统计

## 🚀 技术特性

### 1. 性能优化
- **位置缓存表** - 减少重复计算
- **批量查询** - 优化宠物信息获取
- **索引优化** - 位置查询、时间排序索引
- **分页查询** - 支持大数据量展示

### 2. 实时更新
- **60秒定位更新** - 自动获取最新位置
- **在线状态监控** - 实时更新用户活跃状态
- **距离重新计算** - 位置变化时自动更新距离

### 3. 权限控制
- **可见范围控制** - 动态内容权限管理
- **访客/宠主视角** - 不同权限显示不同内容
- **关注关系验证** - 基于关注状态的内容访问

### 4. 数据安全
- **参数验证** - 完整的输入参数校验
- **权限检查** - 操作权限验证
- **事务管理** - 数据一致性保证

## 📱 前端集成要点

### 1. 定位权限
- iOS：Core Location框架
- Android：Fused Location Provider
- 后台定位权限申请和管理

### 2. 地图集成
- 高德地图/百度地图SDK
- 地址搜索和坐标转换
- 地图标点和范围显示

### 3. 实时更新
- 定时器：60秒位置更新
- WebSocket：实时消息推送
- 下拉刷新：手动更新数据

### 4. 用户体验
- 加载状态提示
- 无数据友好提示
- 筛选条件重置功能
- 图片懒加载和缓存

## 🔧 部署和维护

### 1. 定时任务
- 清理过期位置缓存
- 批量设置离线用户
- 统计数据更新

### 2. 监控告警
- 定位服务可用性监控
- 数据库性能监控
- 接口响应时间监控

### 3. 数据备份
- 位置数据定期备份
- 用户关系数据备份
- 动态内容备份

这套方案完全满足您的业务需求，提供了完整的"附近"功能实现，包括定位、筛选、展示、社交等所有功能模块。
