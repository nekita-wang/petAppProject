<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å® çˆ±é¡¹ç›® - å¹¿å‘Šæ¥å£æµ‹è¯•é¡µé¢</title>
    <style>
      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .test-section h2 {
        color: #666;
        margin-top: 0;
      }
      .ad-position-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-success:hover {
        background-color: #1e7e34;
      }
      .result-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
      .ad-display {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      .ad-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        min-width: 300px;
        flex: 1;
      }
      .ad-image {
        width: 100%;
        max-width: 200px;
        height: auto;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .ad-info {
        font-size: 14px;
        line-height: 1.6;
      }
      .ad-info strong {
        color: #333;
      }
      .error {
        color: #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .loading {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 12px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¾ å® çˆ±é¡¹ç›® - å¹¿å‘Šæ¥å£æµ‹è¯•é¡µé¢</h1>

      <!-- APPç«¯å¹¿å‘Šå±•ç¤ºæµ‹è¯• -->
      <div class="test-section">
        <h2>ğŸ“± APPç«¯å¹¿å‘Šå±•ç¤ºæµ‹è¯•</h2>
        <p>
          æµ‹è¯•å„ä¸ªå¹¿å‘Šä½çš„å¹¿å‘Šå±•ç¤ºæ•ˆæœã€‚ç‚¹å‡»å¹¿å‘Šå›¾ç‰‡æˆ–æŒ‰é’®ä¼šç»Ÿè®¡ç‚¹å‡»é‡å¹¶è·³è½¬åˆ°ä¾›åº”å•†é“¾æ¥ã€‚
        </p>

        <div class="ad-position-buttons">
          <button class="btn btn-primary" onclick="getAdvertisement(1)">
            å¹¿å‘Šä½ 1
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(2)">
            å¹¿å‘Šä½ 2
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(3)">
            å¹¿å‘Šä½ 3
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(4)">
            å¹¿å‘Šä½ 4
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(5)">
            å¹¿å‘Šä½ 5
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(6)">
            å¹¿å‘Šä½ 6
          </button>
          <button class="btn btn-success" onclick="getAllAdvertisements()">
            è·å–æ‰€æœ‰å¹¿å‘Šä½
          </button>
        </div>

        <div id="adResult" class="result-container" style="display: none">
          <div id="adContent"></div>
        </div>
      </div>

      <!-- å¹¿å‘Šç»Ÿè®¡æµ‹è¯• -->
      <div class="test-section">
        <h2>ğŸ“Š å¹¿å‘Šç»Ÿè®¡æ•°æ®æµ‹è¯•</h2>
        <p>è·å–å¹¿å‘Šçš„ç»Ÿè®¡æ•°æ®ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰</p>

        <div>
          <input
            type="text"
            id="adminToken"
            placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜Token"
            style="
              width: 300px;
              padding: 8px;
              margin-right: 10px;
              border: 1px solid #ddd;
              border-radius: 4px;
            "
          />
          <button class="btn btn-success" onclick="getStatistics()">
            è·å–ç»Ÿè®¡æ•°æ®
          </button>
        </div>

        <div id="statsResult" class="result-container" style="display: none">
          <div id="statsContent"></div>
        </div>
      </div>

      <!-- æ¥å£ä¿¡æ¯ -->
      <div class="test-section">
        <h2>ğŸ”— æ¥å£ä¿¡æ¯</h2>
        <div class="ad-info">
          <p><strong>æœåŠ¡åœ°å€:</strong> http://localhost:8080</p>
          <p>
            <strong>è·å–å¹¿å‘Šæ¥å£:</strong> GET
            /app/advertisement/position/{adPosition}
          </p>
          <p>
            <strong>ç‚¹å‡»ç»Ÿè®¡æ¥å£:</strong> POST
            /app/advertisement/click/{adPosition}
          </p>
          <p>
            <strong>æ‰¹é‡è·å–æ¥å£:</strong> GET
            /app/advertisement/batch?positions=1,2,3
          </p>
          <p><strong>ç»Ÿè®¡æ•°æ®æ¥å£:</strong> GET /advertisement/statistics</p>
          <p>
            <strong>ç‰¹ç‚¹:</strong>
            APPç«¯æ¥å£æ— éœ€è®¤è¯ï¼Œç‚¹å‡»æ—¶è‡ªåŠ¨ç»Ÿè®¡å¹¶è¿”å›è·³è½¬é“¾æ¥ï¼Œç»Ÿè®¡æ¥å£éœ€è¦ç®¡ç†å‘˜æƒé™
          </p>
        </div>
      </div>
    </div>

    <script>
      const baseUrl = "http://localhost:8080";

      // è·å–æŒ‡å®šå¹¿å‘Šä½çš„å¹¿å‘Š
      async function getAdvertisement(position) {
        const resultDiv = document.getElementById("adResult");
        const contentDiv = document.getElementById("adContent");

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = `<p>æ­£åœ¨è·å–å¹¿å‘Šä½ ${position} çš„å¹¿å‘Š...</p>`;

        try {
          const response = await fetch(
            `${baseUrl}/app/advertisement/position/${position}`
          );
          const data = await response.json();

          if (data.code === 200) {
            if (data.data) {
              displayAdvertisement(data.data, position);
              resultDiv.className = "result-container success";
            } else {
              contentDiv.innerHTML = `<p>å¹¿å‘Šä½ ${position} æš‚æ— è¿è¡Œä¸­çš„å¹¿å‘Š</p>`;
              resultDiv.className = "result-container";
            }
          } else {
            contentDiv.innerHTML = `<p>è·å–å¤±è´¥: ${data.msg}</p>`;
            resultDiv.className = "result-container error";
          }
        } catch (error) {
          contentDiv.innerHTML = `<p>è¯·æ±‚å¤±è´¥: ${error.message}</p><p>è¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨ä¸”åœ°å€æ­£ç¡®</p>`;
          resultDiv.className = "result-container error";
        }
      }

      // æ˜¾ç¤ºå¹¿å‘Šä¿¡æ¯
      function displayAdvertisement(ad, position) {
        const contentDiv = document.getElementById("adContent");
        const imageUrl = ad.adImage ? `${baseUrl}${ad.adImage}` : "";

        contentDiv.innerHTML = `
                <h3>å¹¿å‘Šä½ ${position} - ${ad.adName}</h3>
                <div class="ad-display">
                    <div class="ad-card">
                        ${
                          imageUrl
                            ? `<div style="position: relative; cursor: pointer;" onclick="clickAdvertisement(${position})">
                                 <img src="${imageUrl}" alt="${ad.adName}" class="ad-image" onerror="this.style.display='none'">
                                 <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                   ç‚¹å‡»è·³è½¬
                                 </div>
                               </div>`
                            : ""
                        }
                        <div class="ad-info">
                            <p><strong>å¹¿å‘Šåç§°:</strong> ${ad.adName}</p>
                            <p><strong>å“ç‰Œæ–¹:</strong> ${ad.brand}</p>
                            <p><strong>ç‚¹å‡»é‡:</strong> ${ad.clickCount}</p>
                            <p><strong>ç›®æ ‡é“¾æ¥:</strong> <a href="${
                              ad.targetUrl
                            }" target="_blank">${ad.targetUrl}</a></p>
                            <p><strong>æŠ•æ”¾æ—¶é—´:</strong> ${ad.adStartTime} ~ ${
          ad.adEndTime
        }</p>
                            <button class="btn btn-success" onclick="clickAdvertisement(${position})" style="margin-top: 10px;">
                              ğŸ”— ç‚¹å‡»å¹¿å‘Šï¼ˆç»Ÿè®¡ç‚¹å‡»é‡ï¼‰
                            </button>
                        </div>
                    </div>
                </div>
                <details>
                    <summary>æŸ¥çœ‹å®Œæ•´å“åº”æ•°æ®</summary>
                    <pre>${JSON.stringify(ad, null, 2)}</pre>
                </details>
            `;
      }

      // è·å–æ‰€æœ‰å¹¿å‘Šä½çš„å¹¿å‘Š
      async function getAllAdvertisements() {
        const resultDiv = document.getElementById("adResult");
        const contentDiv = document.getElementById("adContent");

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = "<p>æ­£åœ¨è·å–æ‰€æœ‰å¹¿å‘Šä½çš„å¹¿å‘Š...</p>";

        const advertisements = [];

        for (let i = 1; i <= 6; i++) {
          try {
            const response = await fetch(
              `${baseUrl}/app/advertisement/position/${i}`
            );
            const data = await response.json();

            if (data.code === 200 && data.data) {
              advertisements.push({ position: i, ad: data.data });
            }
          } catch (error) {
            console.error(`è·å–å¹¿å‘Šä½ ${i} å¤±è´¥:`, error);
          }
        }

        if (advertisements.length > 0) {
          displayAllAdvertisements(advertisements);
          resultDiv.className = "result-container success";
        } else {
          contentDiv.innerHTML = "<p>æš‚æ— è¿è¡Œä¸­çš„å¹¿å‘Š</p>";
          resultDiv.className = "result-container";
        }
      }

      // æ˜¾ç¤ºæ‰€æœ‰å¹¿å‘Š
      function displayAllAdvertisements(advertisements) {
        const contentDiv = document.getElementById("adContent");

        let html = '<h3>æ‰€æœ‰è¿è¡Œä¸­çš„å¹¿å‘Š</h3><div class="ad-display">';

        advertisements.forEach((item) => {
          const ad = item.ad;
          const imageUrl = ad.adImage ? `${baseUrl}${ad.adImage}` : "";

          html += `
                    <div class="ad-card">
                        <h4>å¹¿å‘Šä½ ${item.position}</h4>
                        ${
                          imageUrl
                            ? `<div style="position: relative; cursor: pointer;" onclick="clickAdvertisement(${item.position})">
                                 <img src="${imageUrl}" alt="${ad.adName}" class="ad-image" onerror="this.style.display='none'">
                                 <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                   ç‚¹å‡»è·³è½¬
                                 </div>
                               </div>`
                            : ""
                        }
                        <div class="ad-info">
                            <p><strong>${ad.adName}</strong></p>
                            <p>å“ç‰Œ: ${ad.brand}</p>
                            <p>ç‚¹å‡»é‡: ${ad.clickCount}</p>
                            <p><a href="${
                              ad.targetUrl
                            }" target="_blank">è®¿é—®é“¾æ¥</a></p>
                            <button class="btn btn-success" onclick="clickAdvertisement(${
                              item.position
                            })" style="margin-top: 10px; font-size: 12px;">
                              ğŸ”— ç‚¹å‡»å¹¿å‘Š
                            </button>
                        </div>
                    </div>
                `;
        });

        html += "</div>";
        contentDiv.innerHTML = html;
      }

      // è·å–ç»Ÿè®¡æ•°æ®
      async function getStatistics() {
        const token = document.getElementById("adminToken").value;
        const resultDiv = document.getElementById("statsResult");
        const contentDiv = document.getElementById("statsContent");

        if (!token) {
          alert("è¯·è¾“å…¥ç®¡ç†å‘˜Token");
          return;
        }

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = "<p>æ­£åœ¨è·å–ç»Ÿè®¡æ•°æ®...</p>";

        try {
          const response = await fetch(`${baseUrl}/advertisement/statistics`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          const data = await response.json();

          if (data.code === 200) {
            displayStatistics(data.data);
            resultDiv.className = "result-container success";
          } else {
            contentDiv.innerHTML = `<p>è·å–å¤±è´¥: ${data.msg}</p>`;
            resultDiv.className = "result-container error";
          }
        } catch (error) {
          contentDiv.innerHTML = `<p>è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
          resultDiv.className = "result-container error";
        }
      }

      // æ˜¾ç¤ºç»Ÿè®¡æ•°æ®
      function displayStatistics(stats) {
        const contentDiv = document.getElementById("statsContent");

        contentDiv.innerHTML = `
                <h3>å¹¿å‘Šç»Ÿè®¡æ•°æ®</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalAds || 0}</div>
                        <div class="stat-label">æ€»å¹¿å‘Šæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.runningAds || 0}</div>
                        <div class="stat-label">è¿è¡Œä¸­</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.clearedAds || 0}</div>
                        <div class="stat-label">å·²ç»“æ¸…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.invalidAds || 0}</div>
                        <div class="stat-label">å·²å¤±æ•ˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalClicks || 0}</div>
                        <div class="stat-label">æ€»ç‚¹å‡»é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">Â¥${
                          stats.totalRevenue || 0
                        }</div>
                        <div class="stat-label">æ€»æ”¶å…¥</div>
                    </div>
                </div>
                <details style="margin-top: 20px;">
                    <summary>æŸ¥çœ‹å®Œæ•´ç»Ÿè®¡æ•°æ®</summary>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                </details>
            `;
      }

      // ç‚¹å‡»å¹¿å‘Šï¼ˆç»Ÿè®¡ç‚¹å‡»é‡å¹¶è·³è½¬ï¼‰
      async function clickAdvertisement(position) {
        console.log(`ç‚¹å‡»å¹¿å‘Šä½ ${position}`);

        try {
          const response = await fetch(
            `${baseUrl}/app/advertisement/click/${position}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          const data = await response.json();

          if (data.code === 200) {
            const targetUrl = data.data;
            console.log(`å¹¿å‘Šç‚¹å‡»æˆåŠŸï¼Œè·³è½¬åˆ°: ${targetUrl}`);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            alert(`âœ… å¹¿å‘Šç‚¹å‡»ç»Ÿè®¡æˆåŠŸï¼\nå³å°†è·³è½¬åˆ°: ${targetUrl}`);

            // è·³è½¬åˆ°ç›®æ ‡é“¾æ¥
            if (targetUrl) {
              window.open(targetUrl, "_blank");
            }

            // åˆ·æ–°å½“å‰å¹¿å‘Šæ•°æ®ä»¥æ˜¾ç¤ºæ›´æ–°åçš„ç‚¹å‡»é‡
            setTimeout(() => {
              getAdvertisement(position);
            }, 1000);
          } else {
            console.error("å¹¿å‘Šç‚¹å‡»å¤±è´¥:", data.msg);
            alert(`âŒ å¹¿å‘Šç‚¹å‡»å¤±è´¥: ${data.msg}`);
          }
        } catch (error) {
          console.error("å¹¿å‘Šç‚¹å‡»è¯·æ±‚å¤±è´¥:", error);
          alert(
            `âŒ å¹¿å‘Šç‚¹å‡»è¯·æ±‚å¤±è´¥: ${error.message}\nè¯·ç¡®ä¿æœåŠ¡å·²å¯åŠ¨ä¸”åœ°å€æ­£ç¡®`
          );
        }
      }

      // è·å–çŠ¶æ€æ–‡æœ¬
      function getStatusText(status) {
        switch (status) {
          case 1:
            return "è¿è¡Œä¸­";
          case 2:
            return "å·²ç»“æ¸…";
          case 3:
            return "å·²å¤±æ•ˆ";
          default:
            return "æœªçŸ¥çŠ¶æ€";
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
      window.onload = function () {
        console.log("å¹¿å‘Šæ¥å£æµ‹è¯•é¡µé¢å·²åŠ è½½");
        console.log("æœåŠ¡åœ°å€:", baseUrl);
      };
    </script>
  </body>
</html>
