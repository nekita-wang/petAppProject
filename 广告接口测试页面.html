<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>宠爱项目 - 广告接口测试页面</title>
    <style>
      body {
        font-family: "Microsoft YaHei", Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .test-section h2 {
        color: #666;
        margin-top: 0;
      }
      .ad-position-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s;
      }
      .btn-primary {
        background-color: #007bff;
        color: white;
      }
      .btn-primary:hover {
        background-color: #0056b3;
      }
      .btn-success {
        background-color: #28a745;
        color: white;
      }
      .btn-success:hover {
        background-color: #1e7e34;
      }
      .result-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
      .ad-display {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
      }
      .ad-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        min-width: 300px;
        flex: 1;
      }
      .ad-image {
        width: 100%;
        max-width: 200px;
        height: auto;
        border-radius: 5px;
        margin-bottom: 10px;
      }
      .ad-info {
        font-size: 14px;
        line-height: 1.6;
      }
      .ad-info strong {
        color: #333;
      }
      .error {
        color: #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .success {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .loading {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 12px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 5px;
      }
      .stat-label {
        font-size: 14px;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🐾 宠爱项目 - 广告接口测试页面</h1>

      <!-- APP端广告展示测试 -->
      <div class="test-section">
        <h2>📱 APP端广告展示测试</h2>
        <p>
          测试各个广告位的广告展示效果。点击广告图片或按钮会统计点击量并跳转到供应商链接。
        </p>

        <div class="ad-position-buttons">
          <button class="btn btn-primary" onclick="getAdvertisement(1)">
            广告位 1
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(2)">
            广告位 2
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(3)">
            广告位 3
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(4)">
            广告位 4
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(5)">
            广告位 5
          </button>
          <button class="btn btn-primary" onclick="getAdvertisement(6)">
            广告位 6
          </button>
          <button class="btn btn-success" onclick="getAllAdvertisements()">
            获取所有广告位
          </button>
        </div>

        <div id="adResult" class="result-container" style="display: none">
          <div id="adContent"></div>
        </div>
      </div>

      <!-- 广告统计测试 -->
      <div class="test-section">
        <h2>📊 广告统计数据测试</h2>
        <p>获取广告的统计数据（需要管理员权限）</p>

        <div>
          <input
            type="text"
            id="adminToken"
            placeholder="请输入管理员Token"
            style="
              width: 300px;
              padding: 8px;
              margin-right: 10px;
              border: 1px solid #ddd;
              border-radius: 4px;
            "
          />
          <button class="btn btn-success" onclick="getStatistics()">
            获取统计数据
          </button>
        </div>

        <div id="statsResult" class="result-container" style="display: none">
          <div id="statsContent"></div>
        </div>
      </div>

      <!-- 接口信息 -->
      <div class="test-section">
        <h2>🔗 接口信息</h2>
        <div class="ad-info">
          <p><strong>服务地址:</strong> http://localhost:8080</p>
          <p>
            <strong>获取广告接口:</strong> GET
            /app/advertisement/position/{adPosition}
          </p>
          <p>
            <strong>点击统计接口:</strong> POST
            /app/advertisement/click/{adPosition}
          </p>
          <p>
            <strong>批量获取接口:</strong> GET
            /app/advertisement/batch?positions=1,2,3
          </p>
          <p><strong>统计数据接口:</strong> GET /advertisement/statistics</p>
          <p>
            <strong>特点:</strong>
            APP端接口无需认证，点击时自动统计并返回跳转链接，统计接口需要管理员权限
          </p>
        </div>
      </div>
    </div>

    <script>
      const baseUrl = "http://localhost:8080";

      // 获取指定广告位的广告
      async function getAdvertisement(position) {
        const resultDiv = document.getElementById("adResult");
        const contentDiv = document.getElementById("adContent");

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = `<p>正在获取广告位 ${position} 的广告...</p>`;

        try {
          const response = await fetch(
            `${baseUrl}/app/advertisement/position/${position}`
          );
          const data = await response.json();

          if (data.code === 200) {
            if (data.data) {
              displayAdvertisement(data.data, position);
              resultDiv.className = "result-container success";
            } else {
              contentDiv.innerHTML = `<p>广告位 ${position} 暂无运行中的广告</p>`;
              resultDiv.className = "result-container";
            }
          } else {
            contentDiv.innerHTML = `<p>获取失败: ${data.msg}</p>`;
            resultDiv.className = "result-container error";
          }
        } catch (error) {
          contentDiv.innerHTML = `<p>请求失败: ${error.message}</p><p>请确保服务已启动且地址正确</p>`;
          resultDiv.className = "result-container error";
        }
      }

      // 显示广告信息
      function displayAdvertisement(ad, position) {
        const contentDiv = document.getElementById("adContent");
        const imageUrl = ad.adImage ? `${baseUrl}${ad.adImage}` : "";

        contentDiv.innerHTML = `
                <h3>广告位 ${position} - ${ad.adName}</h3>
                <div class="ad-display">
                    <div class="ad-card">
                        ${
                          imageUrl
                            ? `<div style="position: relative; cursor: pointer;" onclick="clickAdvertisement(${position})">
                                 <img src="${imageUrl}" alt="${ad.adName}" class="ad-image" onerror="this.style.display='none'">
                                 <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                   点击跳转
                                 </div>
                               </div>`
                            : ""
                        }
                        <div class="ad-info">
                            <p><strong>广告名称:</strong> ${ad.adName}</p>
                            <p><strong>品牌方:</strong> ${ad.brand}</p>
                            <p><strong>点击量:</strong> ${ad.clickCount}</p>
                            <p><strong>目标链接:</strong> <a href="${
                              ad.targetUrl
                            }" target="_blank">${ad.targetUrl}</a></p>
                            <p><strong>投放时间:</strong> ${ad.adStartTime} ~ ${
          ad.adEndTime
        }</p>
                            <button class="btn btn-success" onclick="clickAdvertisement(${position})" style="margin-top: 10px;">
                              🔗 点击广告（统计点击量）
                            </button>
                        </div>
                    </div>
                </div>
                <details>
                    <summary>查看完整响应数据</summary>
                    <pre>${JSON.stringify(ad, null, 2)}</pre>
                </details>
            `;
      }

      // 获取所有广告位的广告
      async function getAllAdvertisements() {
        const resultDiv = document.getElementById("adResult");
        const contentDiv = document.getElementById("adContent");

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = "<p>正在获取所有广告位的广告...</p>";

        const advertisements = [];

        for (let i = 1; i <= 6; i++) {
          try {
            const response = await fetch(
              `${baseUrl}/app/advertisement/position/${i}`
            );
            const data = await response.json();

            if (data.code === 200 && data.data) {
              advertisements.push({ position: i, ad: data.data });
            }
          } catch (error) {
            console.error(`获取广告位 ${i} 失败:`, error);
          }
        }

        if (advertisements.length > 0) {
          displayAllAdvertisements(advertisements);
          resultDiv.className = "result-container success";
        } else {
          contentDiv.innerHTML = "<p>暂无运行中的广告</p>";
          resultDiv.className = "result-container";
        }
      }

      // 显示所有广告
      function displayAllAdvertisements(advertisements) {
        const contentDiv = document.getElementById("adContent");

        let html = '<h3>所有运行中的广告</h3><div class="ad-display">';

        advertisements.forEach((item) => {
          const ad = item.ad;
          const imageUrl = ad.adImage ? `${baseUrl}${ad.adImage}` : "";

          html += `
                    <div class="ad-card">
                        <h4>广告位 ${item.position}</h4>
                        ${
                          imageUrl
                            ? `<div style="position: relative; cursor: pointer;" onclick="clickAdvertisement(${item.position})">
                                 <img src="${imageUrl}" alt="${ad.adName}" class="ad-image" onerror="this.style.display='none'">
                                 <div style="position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">
                                   点击跳转
                                 </div>
                               </div>`
                            : ""
                        }
                        <div class="ad-info">
                            <p><strong>${ad.adName}</strong></p>
                            <p>品牌: ${ad.brand}</p>
                            <p>点击量: ${ad.clickCount}</p>
                            <p><a href="${
                              ad.targetUrl
                            }" target="_blank">访问链接</a></p>
                            <button class="btn btn-success" onclick="clickAdvertisement(${
                              item.position
                            })" style="margin-top: 10px; font-size: 12px;">
                              🔗 点击广告
                            </button>
                        </div>
                    </div>
                `;
        });

        html += "</div>";
        contentDiv.innerHTML = html;
      }

      // 获取统计数据
      async function getStatistics() {
        const token = document.getElementById("adminToken").value;
        const resultDiv = document.getElementById("statsResult");
        const contentDiv = document.getElementById("statsContent");

        if (!token) {
          alert("请输入管理员Token");
          return;
        }

        resultDiv.style.display = "block";
        resultDiv.className = "result-container loading";
        contentDiv.innerHTML = "<p>正在获取统计数据...</p>";

        try {
          const response = await fetch(`${baseUrl}/advertisement/statistics`, {
            headers: {
              Authorization: `Bearer ${token}`,
              "Content-Type": "application/json",
            },
          });
          const data = await response.json();

          if (data.code === 200) {
            displayStatistics(data.data);
            resultDiv.className = "result-container success";
          } else {
            contentDiv.innerHTML = `<p>获取失败: ${data.msg}</p>`;
            resultDiv.className = "result-container error";
          }
        } catch (error) {
          contentDiv.innerHTML = `<p>请求失败: ${error.message}</p>`;
          resultDiv.className = "result-container error";
        }
      }

      // 显示统计数据
      function displayStatistics(stats) {
        const contentDiv = document.getElementById("statsContent");

        contentDiv.innerHTML = `
                <h3>广告统计数据</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalAds || 0}</div>
                        <div class="stat-label">总广告数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.runningAds || 0}</div>
                        <div class="stat-label">运行中</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.clearedAds || 0}</div>
                        <div class="stat-label">已结清</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.invalidAds || 0}</div>
                        <div class="stat-label">已失效</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.totalClicks || 0}</div>
                        <div class="stat-label">总点击量</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">¥${
                          stats.totalRevenue || 0
                        }</div>
                        <div class="stat-label">总收入</div>
                    </div>
                </div>
                <details style="margin-top: 20px;">
                    <summary>查看完整统计数据</summary>
                    <pre>${JSON.stringify(stats, null, 2)}</pre>
                </details>
            `;
      }

      // 点击广告（统计点击量并跳转）
      async function clickAdvertisement(position) {
        console.log(`点击广告位 ${position}`);

        try {
          const response = await fetch(
            `${baseUrl}/app/advertisement/click/${position}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          const data = await response.json();

          if (data.code === 200) {
            const targetUrl = data.data;
            console.log(`广告点击成功，跳转到: ${targetUrl}`);

            // 显示成功提示
            alert(`✅ 广告点击统计成功！\n即将跳转到: ${targetUrl}`);

            // 跳转到目标链接
            if (targetUrl) {
              window.open(targetUrl, "_blank");
            }

            // 刷新当前广告数据以显示更新后的点击量
            setTimeout(() => {
              getAdvertisement(position);
            }, 1000);
          } else {
            console.error("广告点击失败:", data.msg);
            alert(`❌ 广告点击失败: ${data.msg}`);
          }
        } catch (error) {
          console.error("广告点击请求失败:", error);
          alert(
            `❌ 广告点击请求失败: ${error.message}\n请确保服务已启动且地址正确`
          );
        }
      }

      // 获取状态文本
      function getStatusText(status) {
        switch (status) {
          case 1:
            return "运行中";
          case 2:
            return "已结清";
          case 3:
            return "已失效";
          default:
            return "未知状态";
        }
      }

      // 页面加载完成后自动测试
      window.onload = function () {
        console.log("广告接口测试页面已加载");
        console.log("服务地址:", baseUrl);
      };
    </script>
  </body>
</html>
