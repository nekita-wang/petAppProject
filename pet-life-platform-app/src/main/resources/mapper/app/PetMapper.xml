<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.petlife.platform.app.mapper.PetMapper">

    <!-- 查询同一用户下是否有相同宠物昵称 -->
    <select id="countByUserIdAndNickname" resultType="int">
        SELECT COUNT(*)
        FROM pet_info
        WHERE user_id = #{userId}
          AND pet_nick_name = #{nickname}
    </select>

    <select id="countByUserId" resultType="int">
        SELECT COUNT(*) FROM pet_info WHERE user_id = #{userId}
    </select>


    <select id="selectPetBreedAppList" resultType="com.petlife.platform.common.pojo.vo.PetBreedVo">
        SELECT b.cn_initials AS cnInitials,
               b.pet_class,
               b.pet_breed,
               b.pet_breed_en
        FROM pet_breed b
        JOIN pet_classification c ON b.pet_class_id = c.pet_class_id
        WHERE b.pet_class = #{petClass}
          AND b.status = 0
          AND c.status = 0
        <if test="petBreed != null and petBreed != ''">
            AND b.pet_breed LIKE CONCAT('%', #{petBreed}, '%')
        </if>
        ORDER BY b.cn_initials ASC, b.pet_breed ASC;
    </select>

    <!-- 添加宠物信息 -->
    <insert id="insertPetInfo">
            INSERT INTO pet_info (
               user_id,
               pet_nick_name,
               pet_class,
               pet_breed,
               pet_gender,
               sterilized,
               pet_birthday,
               adoption_date,
               pet_avatar_url,
               status)
        VALUES (#{userId},
                #{petNickName},
                #{petClass},
                #{petBreed},
                #{petGender},
                #{sterilized},
                #{petBirthday},
                #{adoptionDate},
                #{petAvatarURL},
                #{status})
    </insert>

    <select id="selectHot" resultType="String">
        SELECT b.pet_breed
        FROM pet_breed b
        JOIN pet_classification c ON b.pet_class_id = c.pet_class_id
        WHERE b.pet_class = #{petClass}
          AND b.status = 0
          AND c.status = 0
          AND b.pet_breed IN (
            SELECT pi.pet_breed
            FROM pet_info pi
            WHERE pi.pet_class = #{petClass}
              AND pi.status = 0
          )
        GROUP BY b.pet_breed
        ORDER BY (
            SELECT COUNT(*)
            FROM pet_info pi2
            WHERE pi2.pet_breed = b.pet_breed
              AND pi2.status = 0
        ) DESC
        LIMIT 6;
    </select>

    <select id="selectPetClass" resultType="com.petlife.platform.common.pojo.vo.PetClassVo" >
        SELECT pet_class_id AS petClassId, pet_class AS petClass
        FROM pet_classification
        WHERE status = 0
    </select>
</mapper>
